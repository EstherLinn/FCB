@using Foundation.Wealth.Helper;
@using Feature.Wealth.Component.Models.DiscountPremium
@model DiscountPremiumModel

@if (Model.Item == null)
{
    return;
}
@{
    var modelitem = Model.Item;
}

<div class="l-mainstage">
    <div class="l-mainstage__wrap">
        <div class="l-mainstage__title">
            <h1 class="t-title">@Html.Sitecore().Field(Template.DiscountPremium.Fields.MainTitle.ToString(), modelitem)</h1>
        </div>
        <div class="l-mainstage__content">
            <div class="l-flex u-flex-col u-flex-gap-sm">
                <div class="l-flex__item">
                    @Html.Sitecore().Field(Template.DiscountPremium.Fields.SubTitle.ToString(), modelitem)
                </div>
                <div class="l-flex__item">
                    <span class="t-note">@Html.Sitecore().Field(Template.DiscountPremium.Fields.Content.ToString(), modelitem)</span>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="l-wrap">
    <div class="c-tab c-tab--wide" data-tab="true">
        <div class="c-tab__header">
            <ul class="c-tab__navs">
                <!-- .is-active: 作用中的項目 -->
                <!-- [data-tab-target]: 值需對應 [data-tab-panel-id] 的值，按下後會自動顯示相對的 panel -->
                <!-- 若為外連，不要賦予[data-tab-target]屬性 -->
                <li><a href="#" class="c-tab__item is-active" target="_self" title="溢價" data-tab-target="tab-1" value="1" id="SmartType">溢價</a></li>
                <li><a href="#" class="c-tab__item " target="_self" title="折價" data-tab-target="tab-2">折價</a></li>
            </ul>
            <div class="c-tab__collapse">
                <a href="#" class="c-tab__switch"></a>
                <div class="c-tab__dropdown"><a href="#" class="c-tab__clone is-active" target="_self" title="溢價" data-tab-target="tab-1">溢價</a><a href="#" class="c-tab__clone " target="_self" title="折價" data-tab-target="tab-2">折價</a></div>
            </div>
        </div>
        <!-- is-active: 作用中的項目 -->
        <div class="c-tab__panel is-active" data-tab-panel-id="tab-1">
            <div class="l-flex u-flex-col u-flex-gap-max">

                <div class="l-flex__item">
                    <div class="l-flex u-flex-col u-flex-gap-sm">
                        <div class="l-flex__item" data-filter-empty="false">
                            <div class="l-flex l-flex--wrap u-flex-gap-sm">
                                <div class="l-flex__item u-right u-hidden@dt-only">
                                    <div class="o-sortingbox">
                                        <!-- [data-sortingbox="true"]: 載入後自動綁定手機版排序客製樣式下拉功能 -->
                                        <select class="o-sortingbox__input" data-sortingbox="true" data-sorting-linkto="hotTable" id="uid-sortbox1">
                                            <option value="">排序</option>
                                            <option value="ETF名稱高至低" data-sorting-column="ProductCode" data-sorting-class="is-desc">ETF名稱高至低</option>
                                            <option value="ETF名稱低至高" data-sorting-column="ProductCode" data-sorting-class="is-asc">ETF名稱低至高</option>
                                            <option value="交易所代碼高至低" data-sorting-column="ExchangeCode" data-sorting-class="is-desc">交易所代碼高至低</option>
                                            <option value="交易所代碼低至高" data-sorting-column="ExchangeCode" data-sorting-class="is-asc">交易所代碼低至高</option>
                                            <option value="市價高至低" data-sorting-column="MarketPrice" data-sorting-class="is-desc">市價高至低</option>
                                            <option value="市價低至高" data-sorting-column="MarketPrice" data-sorting-class="is-asc">市價低至高</option>
                                            <option value="折溢價高至低" data-sorting-column="DiscountPremium.Value" data-sorting-class="is-desc">折溢價高至低</option>
                                            <option value="折溢價低至高" data-sorting-column="DiscountPremium.Value" data-sorting-class="is-asc">折溢價低至高</option>
                                            <option value="最新量高至低" data-sorting-column="LatestVolumeTradingVolume.Value" data-sorting-class="is-desc">最新量高至低</option>
                                            <option value="最新量低至高" data-sorting-column="LatestVolumeTradingVolume.Value" data-sorting-class="is-asc">最新量低至高</option>
                                            <option value="最新量-10日量高至低" data-sorting-column="LatestVolumeTradingVolumeTenDayAverageVolume.Value" data-sorting-class="is-desc">最新量-10日量高至低</option>
                                            <option value="最新量-10日量低至高" data-sorting-column="LatestVolumeTradingVolumeTenDayAverageVolume.Value" data-sorting-class="is-asc">最新量-10日量低至高</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="l-flex__item" data-filter-empty="false">
                            <div class="l-table">
                                <table class="c-table@dt-only c-cardTable@lt" data-table-name="hotTable" id="table1">
                                    <colgroup>
                                        <col style="width: auto;">
                                        <col style="width: 1%;">
                                        <col style="width: 1%;">
                                        <col style="width: 1%;">
                                        <col style="width: 1%;">
                                        <col style="width: 1%;">
                                        <col style="width: 1%;">
                                        <col style="width: 1%;">
                                    </colgroup>
                                    <thead>
                                        <tr class="u-nowrap">
                                            <th>
                                                <div class="c-table__title">
                                                    <span>ETF名稱</span>
                                                    <!-- .is-asc: 升冪 -->
                                                    <!-- .is-desc: 降冪 -->
                                                    <a href="#" class="o-sorting" data-sorting-column="ProductCode"></a>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="c-table__title">
                                                    <span>交易所代碼</span>
                                                    <a href="#" class="o-sorting" data-sorting-column="ExchangeCode"></a>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="c-table__title">
                                                    <span>市價<br>(日期)</span>
                                                    <a href="#" class="o-sorting" data-sorting-column="MarketPrice"></a>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="c-table__title">
                                                    <span>折溢價</span>
                                                    <a href="#" class="o-sorting" data-sorting-column="DiscountPremium.Value"></a>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="c-table__title">
                                                    <span>最新量</span>
                                                    <a href="#" class="o-sorting" data-sorting-column="LatestVolumeTradingVolume.Value"></a>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="c-table__title">
                                                    <span>最新量-10日量</span>
                                                    <a href="#" class="o-sorting" data-sorting-column="LatestVolumeTradingVolumeTenDayAverageVolume.Value"></a>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="c-table__title">
                                                    <span>關注/比較</span>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="c-table__title">
                                                    <span>申購</span>
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="result1"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="l-flex__item" data-filter-empty="true" style="display:none;">
                            <div class="c-section">
                                <div class="c-section__content">
                                    <div class="c-empty">
                                        <div class="c-empty__img">
                                            <img src="~/themes/images/lions/lion-compare.svg" alt="">
                                        </div>
                                        <div class="c-empty__desc">查無商品，請嘗試調整篩選條件</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="c-tab__panel" data-tab-panel-id="tab-2">
            <div class="l-flex u-flex-col u-flex-gap-max">

                <div class="l-flex__item" data-filter-empty="false">
                    <div class="l-flex u-flex-col u-flex-gap-sm">
                        <div class="l-flex__item">
                            <div class="l-flex l-flex--wrap u-flex-gap-sm">
                                <div class="l-flex__item u-right u-hidden@dt-only">
                                    <div class="o-sortingbox">
                                        <!-- [data-sortingbox="true"]: 載入後自動綁定手機版排序客製樣式下拉功能 -->
                                        <select class="o-sortingbox__input" data-sortingbox="true" data-sorting-linkto="hotTable2" id="uid-sortbox2">
                                            <option value="">排序</option>
                                            <option value="ETF名稱高至低" data-sorting-column="ProductCode" data-sorting-class="is-desc">ETF名稱高至低</option>
                                            <option value="ETF名稱低至高" data-sorting-column="ProductCode" data-sorting-class="is-asc">ETF名稱低至高</option>
                                            <option value="交易所代碼高至低" data-sorting-column="ExchangeCode" data-sorting-class="is-desc">交易所代碼高至低</option>
                                            <option value="交易所代碼低至高" data-sorting-column="ExchangeCode" data-sorting-class="is-asc">交易所代碼低至高</option>
                                            <option value="市價高至低" data-sorting-column="MarketPrice" data-sorting-class="is-desc">市價高至低</option>
                                            <option value="市價低至高" data-sorting-column="MarketPrice" data-sorting-class="is-asc">市價低至高</option>
                                            <option value="折溢價高至低" data-sorting-column="DiscountPremium.Value" data-sorting-class="is-desc">折溢價高至低</option>
                                            <option value="折溢價低至高" data-sorting-column="DiscountPremium.Value" data-sorting-class="is-asc">折溢價低至高</option>
                                            <option value="最新量高至低" data-sorting-column="LatestVolumeTradingVolume.Value" data-sorting-class="is-desc">最新量高至低</option>
                                            <option value="最新量低至高" data-sorting-column="LatestVolumeTradingVolume.Value" data-sorting-class="is-asc">最新量低至高</option>
                                            <option value="最新量-10日量高至低" data-sorting-column="LatestVolumeTradingVolumeTenDayAverageVolume.Value" data-sorting-class="is-desc">最新量-10日量高至低</option>
                                            <option value="最新量-10日量低至高" data-sorting-column="LatestVolumeTradingVolumeTenDayAverageVolume.Value" data-sorting-class="is-asc">最新量-10日量低至高</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="l-flex__item">
                            <div class="l-table">
                                <table class="c-table@dt-only c-cardTable@lt" data-table-name="hotTable2" id="table2">
                                    <colgroup>
                                        <col style="width: auto;">
                                        <col style="width: 1%;">
                                        <col style="width: 1%;">
                                        <col style="width: 1%;">
                                        <col style="width: 1%;">
                                        <col style="width: 1%;">
                                        <col style="width: 1%;">
                                        <col style="width: 1%;">
                                    </colgroup>
                                    <thead>
                                        <tr class="u-nowrap">
                                            <th>
                                                <div class="c-table__title">
                                                    <span>ETF名稱</span>
                                                    <!-- .is-asc: 升冪 -->
                                                    <!-- .is-desc: 降冪 -->
                                                    <a href="#" class="o-sorting" data-sorting-column="ProductCode"></a>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="c-table__title">
                                                    <span>交易所代碼</span>
                                                    <a href="#" class="o-sorting" data-sorting-column="ExchangeCode"></a>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="c-table__title">
                                                    <span>市價<br>(日期)</span>
                                                    <a href="#" class="o-sorting" data-sorting-column="MarketPrice"></a>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="c-table__title">
                                                    <span>折溢價</span>
                                                    <a href="#" class="o-sorting" data-sorting-column="DiscountPremium.Value"></a>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="c-table__title">
                                                    <span>最新量</span>
                                                    <a href="#" class="o-sorting" data-sorting-column="LatestVolumeTradingVolume.Value"></a>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="c-table__title">
                                                    <span>最新量-10日量</span>
                                                    <a href="#" class="o-sorting" data-sorting-column="LatestVolumeTradingVolumeTenDayAverageVolume.Value"></a>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="c-table__title">
                                                    <span>關注/比較</span>
                                                </div>
                                            </th>
                                            <th>
                                                <div class="c-table__title">
                                                    <span>申購</span>
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="result2"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="l-flex__item" data-filter-empty="true" style="display:none;">
                    <div class="c-section">
                        <div class="c-section__content">
                            <div class="c-empty">
                                <div class="c-empty__img">
                                    <img src="~/themes/images/lions/lion-compare.svg" alt="">
                                </div>
                                <div class="c-empty__desc">查無商品，請嘗試調整篩選條件</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script id="template" type="text/html">
    <tr class="c-cardTable__item u-nowrap@dt-only u-center@dt-only">
        <td class="c-cardTable__top"></td>
        <td class="c-cardTable__header u-wrap@dt-only u-left@dt-only">
            <div class="c-cardTable__content">
                <div class="l-target">
                    <div class="l-target__name">
                        <a href="<%= DetailUrl %>?id=<%= ProductCode %>" class="o-contentLink t-bold u-ellipsis-2" target="_blank"><%= ProductCode %> <%= ProductName %></a>
                    </div>
                    <% if (ETFDiscountTags!=null) { %>
                    <div class="l-target__additional">
                        <ul class="l-tag">
                            <% if (ETFDiscountTags.Length > 0) { %>
                            <% for(var i = 0; i < ETFDiscountTags.length; i++ ) { %>
                            <li class="l-tag__item">
                                <!-- <a href="#" class="o-tag">百元基金</a> -->
                                <span class="o-tag"><%= ETFDiscountTags[i] %></span>
                            </li>
                            <% } %>
                            <% } %>
                        </ul>
                    </div>
                    <% } %>
                </div>
            </div>
        </td>
        <td class="c-cardTable__space"></td>
        <td class="c-cardTable__body" data-card-table-width="1/2">
            <div class="c-cardTable__title" data-length="4">交易所代碼</div>
            <% if (ExchangeCode != null) { %>
            <div class="c-cardTable__content"><%= ExchangeCode %></div>
            <% } else {%>
            <span>-</span>
            <% } %>
        </td>
        <td class="c-cardTable__body" data-card-table-width="1/2">
            <div class="c-cardTable__title" data-length="4">市價<br>(日期)</div>
            <% if (MarketPrice != null) { %>
            <div class="c-cardTable__content"><%= MarketPrice.toFixed(4) %><br><span class="t-date"><%= MarketPriceDate %></span></div>
            <% } else {%>
            <span>-</span>
            <% } %>
        </td>
        <td class="c-cardTable__body" data-card-table-width="1/2">
            <div class="c-cardTable__title" data-length="5">折溢價</div>
            <div class="c-cardTable__content">
                <% if (DiscountPremium.Value!=null) { %>
                <% if (DiscountPremium.Value == 0) { %>
                <span><%= DiscountPremium.Text %>%</span>
                <% } else if (DiscountPremium.Key) { %>
                <span class="o-rise"><%= DiscountPremium.Text %>%</span>
                <% } else { %>
                <span class="o-fall"><%= DiscountPremium.Text %>%</span>
                <% } %>
                <% } else {%>
                <span>-</span>
                <% } %>
            </div>
        </td>
        <td class="c-cardTable__body" data-card-table-width="1/2">
            <div class="c-cardTable__title" data-length="5">最新量</div>
            <% if (LatestVolumeTradingVolume.Key != null) { %>
            <div class="c-cardTable__content"><%= LatestVolumeTradingVolume.Key %></div>
            <% } else {%>
            <span>-</span>
            <% } %>
        </td>
        <td class="c-cardTable__body" data-card-table-width="1/2">
            <div class="c-cardTable__title" data-length="5">最新量-10日量</div>
            <% if (LatestVolumeTradingVolumeTenDayAverageVolume.Key != null) { %>
            <div class="c-cardTable__content"><%= LatestVolumeTradingVolumeTenDayAverageVolume.Key %></div>
            <% } else {%>
            <span>-</span>
            <% } %>
        </td>
        <td class="c-cardTable__space"></td>
        <td class="c-cardTable__footer" data-card-table-width="<%= IsOnlineSubscriptionAvailability == true ? '2/3' : '1/1' %>">
            <div class="c-cardTable__content">
                <ul class="l-collect l-collect--divider@lt">
                    <li class="l-collect__item">
                        <%= FocusTag %>
                    </li>
                    <li class="l-collect__item">
                        <%= CompareTag %>
                    </li>
                </ul>
            </div>
        </td>
        <td class="c-cardTable__footer" data-card-table-width="1/3">
            <div class="c-cardTable__content">
                <% if (IsOnlineSubscriptionAvailability) { %>
                <%= SubscriptionTag %>
                <% } %>
            </div>
        </td>
    </tr>
</script>

<script>
	(function ($, window, document, undefined) {
		document.addEventListener('DOMContentLoaded', function () {
			if (!jQuery) {
				return;
			}
			let fjs;

			let int = '1';
			var token = $('input[name="__RequestVerificationToken"]').val();

			window.loading = () => 0;
			$.ajax({
				url: '@ClientRoute.GenerateUrl(this, "DiscountPremium", "GetAllEtfs")',
				type: 'POST',
				data: { __RequestVerificationToken: token },
				success: function (data) {
				initFilter(data, '1');
				},
				complete: function () {
					$('.c-loading').loading('hide');
					window.loading = (methodOrOptions) => $('.c-loading').loading(methodOrOptions);  // 重新定義 loading
				},
				error: function (xhr, status, error) {
					console.error(error);
				}
			});

			$.ajax({
				url: '@ClientRoute.GenerateUrl(this, "DiscountPremium", "GetAllEtfs2")',
				type: 'POST',
				data: { __RequestVerificationToken: token },
			}).done(function (data, textStatus, jqXHR) {
				initFilter(data, '2');

				console.log(data);
			}).fail(function (jqXHR, textStatus, errorThrown) {
			}).always(function () {
				window.loading('hide');
			});
			function initFilter(data, int) {
				let uid = 'select#uid-sortbox' + int;
				let result = '#result' + int;
				let table = '#table' + int;
				let opts = {
					template: '#template',
					callbacks: {
						beforeRecordRender: function (record) {
							const dot2 = 2;
							record.DiscountPremium.Text = Math.abs(record.DiscountPremium.Value).toFixed(dot2);
						},
						afterFilter: function (result) {
							let isEmpty = result.length == 0;
							$(`[data-filter-empty=${isEmpty}]`).show();
							$(`[data-filter-empty=${!isEmpty}]`).hide();
							window.loading('hide');
							$('[data-popup]').magnificPopup();
							$('[eh-compare]').trigger('exec');
							$('[eh-focus]').trigger('exec');
							$('[eh-subscription-type]').trigger('exec');
						}
					},
					order: {
						default_sort: 'asc',
						sorts: [
							{ field: 'group1', ele: uid }
						],
						onSortEvent: function (f, e) {
							let $self = $(this);
							if (e.type === 'click') { } else if (e.type === 'change') {
								let $selected = $self.find(':selected');
								let field = $selected.data('sorting-column');
								let order = $selected.data('sorting-class');
								f.field = field;
								if (!!order) {
									if (order === 'is-desc') {
										f.order = 'desc';
									} else if (order === 'is-asc') {
										f.order = 'asc';
									}
								} else {
									f.order = f.order === 'desc' ? 'asc' : 'desc';
								}
							}
						}
					}
				};
				fjs = FilterJS(data, result, opts);
				$('[data-popup]').magnificPopup();
				$('[eh-compare]').trigger('exec');
				$('[eh-focus]').trigger('exec');
				$('[eh-subscription-type]').trigger('exec');
			}

			// table 排序功能
			function initializeSorting(tableId, sortingBoxId, datasortingBox) {
				$(tableId).on('click.sorting', '.o-sorting', function (e) {
					e.preventDefault();
					window.loading('show');
					var $this = $(this);
					var orderby = '';

					if ($this.hasClass('is-asc')) {
						$this.removeClass('is-asc').addClass('is-desc');
						orderby = 'is-desc';
					} else {
						$this.closest('.l-table').find('.o-sorting').removeClass('is-asc is-desc');
						$this.addClass('is-asc');
						orderby = 'is-asc';
					}

					// 連動 sortingbox
					let $sortingbox = $(sortingBoxId);
					var sortingColumn = $this.data('sorting-column');
					let $option = $(`option[data-sorting-column="${sortingColumn}"][data-sorting-class="${orderby}"]`, $sortingbox);
					if ($option.length != 0) {
						$option.prop('selected', true);
						$sortingbox.trigger('change');
					} else {
						$sortingbox.val(null).trigger('change');
					}

					// 因展示，使用 setTimeout 延遲關閉 loading
					setTimeout(() => {
						window.loading('hide');
					}, 300);
				});

				$(sortingBoxId).on('change.select2', function (e) {
					let self = this;
					let $self = $(this);
					let sorting = $self.val();
					let $linkTable = $(tableId);
					let sortingColumn = $('option:selected', self).data('sorting-column');
					let orderby = $('option:selected', self).data('sorting-class');

					// 連動 table
					$('.o-sorting', $linkTable).removeClass('is-asc is-desc');
					$(`[data-sorting-column="${sortingColumn}"]`, $linkTable).addClass(orderby);

					let $linkedBox = $(datasortingBox).not(self);
					for (box of $linkedBox) {
						let $box = $(box);
						let $option = $(`option[data-sorting-column="${sortingColumn}"][data-sorting-class="${orderby}"]`, $box);
						if ($option.length != 0) {
							$option.prop('selected', true);
							$box.trigger('change.select2');
						} else {
							$box.val(null).trigger('change.select2');
						}
					}
				});
			}

			initializeSorting('#table1', '#uid-sortbox1', '[data-sortingbox1]');
			initializeSorting('#table2', '#uid-sortbox2', '[data-sortingbox2]');
		});
	})(jQuery, window, document);
</script>



@using Feature.Wealth.Component.Models.Bond
@model BondDetailModel

@if (Model == null)
{
    return;
}

<div class="l-mainstage">
    <div class="l-mainstage__wrap">
        <div class="l-mainstage__content">
            <div class="l-pageHeader">
                <div class="l-pageHeader__title">
                    <div class="c-pageHeader">
                        <div class="c-pageHeader__main">
                            <h1 class="c-pageHeader__title">@(Model.BondDetail.BondCode + " " + Model.BondDetail.BondName)</h1>
                            <!-- 如果沒有tag，不要放 div.c-pageHeader__tags 區塊 -->
                            @if (Model.BondDetail.Discount != null && Model.BondDetail.Discount.Any())
                            {
                                <div class="c-pageHeader__tags">
                                    <ul class="l-tag">
                                        @foreach (var tag in Model.BondDetail.Discount)
                                        {
                                            <li class="l-tag__item">
                                                <span class="o-tag">@tag</span>
                                            </li>
                                        }
                                    </ul>
                                </div>
                            }
                        </div>
                        <div class="c-pageHeader__subContent">
                            @* <h2 class="c-pageHeader__subTitle">@Model.BondDetail.ISINCode</h2> *@
                        </div>
                        <div class="c-pageHeader__views">
                            <div class="o-views o-views--bk" data-eh="visit-update,visit-exec" eh-visit-pageid="@Model.PageID" eh-visit-qs="id=@Model.BondDetail.BondCode"></div>
                        </div>
                    </div>
                </div>
                <div class="l-pageHeader__content">
                    <div class="l-pageHeader__info">
                        <div class="l-detailInfo">
                            <div class="l-detailInfo__major">
                                <div class="l-detailInfo__item">
                                    <div class="c-numerical">
                                        <div class="c-numerical__title u-left@dt-only"><span>計價幣別</span></div>
                                        <div class="c-numerical__content c-numerical__content--xl u-left@dt-only">
                                            @if(Model.BondDetail.CurrencyName == "無幣別")
                                            {
                                                <span>-</span>
                                            }
                                            else
                                            {
                                                <span>@Model.BondDetail.CurrencyName</span>
                                            }    
                                        </div>
                                    </div>
                                </div>
                                <div class="l-detailInfo__item">
                                    <div class="c-numerical">
                                        <div class="c-numerical__title u-left@dt-only"><span>票面利率</span></div>
                                        <div class="c-numerical__content c-numerical__content--xl u-left@dt-only">
                                            @if (Model.BondDetail.InterestRate == null)
                                            {
                                                <span>-</span>
                                            }
                                            else
                                            {
                                                <span>@(Model.BondDetail.InterestRate)%</span>
                                            }                                        
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="l-detailInfo__lower">
                                <div class="l-detailInfo__item">
                                    <div class="c-numerical c-numerical--horiz@lt">
                                        <div class="c-numerical__title u-left@dt-only"><span>報價日期</span></div>
                                        <div class="c-numerical__content c-numerical__content--xl@dt-only u-left@dt-only"><span>@Model.BondDetail.Date</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="l-detailInfo__lower">
                                <div class="l-detailInfo__item">
                                    <div class="c-numerical c-numerical--horiz@lt">
                                        <div class="c-numerical__title u-left@dt-only"><span>參考贖回價</span></div>
                                        <div class="c-numerical__content c-numerical__content--xl@dt-only u-left@dt-only">
                                            @if (Model.BondDetail.RedemptionFee == null)
                                            {
                                                <span>-</span>
                                            }
                                            else
                                            {
                                                <span>@Model.BondDetail.RedemptionFee</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="l-pageHeader__action">
                        <ul class="l-pageWallet">
                            <li class="l-pageWallet__item">
                                @Model.BondDetail.FocusButton
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="l-wrap">
    <div class="c-tab c-tab--wide" data-tab="true">
        <div class="c-tab__header">
            <ul class="c-tab__navs">
                <!-- .is-active: 作用中的項目 -->
                <!-- [data-tab-target]: 值需對應 [data-tab-panel-id] 的值，按下後會自動顯示相對的 panel -->
                <!-- 若為外連，不要賦予[data-tab-target]屬性 -->
                <li><a href="#" class="c-tab__item is-active" target="_self" title="基本資料" data-tab-target="tab-1">基本資料</a></li>
                <li><a href="#" class="c-tab__item " target="_self" title="歷史價格" data-tab-target="tab-2">歷史價格</a></li>
                <li><a href="#" class="c-tab__item " target="_self" title="配息時程" data-tab-target="tab-3">配息時程</a></li>
                <li><a href="#" class="c-tab__item " target="_self" title="相關商品" data-tab-target="tab-4">相關商品</a></li>
                <li><a href="#" class="c-tab__item " target="_self" title="公司分析" data-tab-target="tab-7">公司分析</a></li>
            </ul>
            <div class="c-tab__collapse">
                <a href="#" class="c-tab__switch"></a>
                <div class="c-tab__dropdown">
                    <a href="#" class="c-tab__clone is-active" target="_self" title="基本資料" data-tab-target="tab-1">基本資料</a>
                    <a href="#" class="c-tab__clone " target="_self" title="歷史價格" data-tab-target="tab-2">歷史價格</a>
                    <a href="#" class="c-tab__clone " target="_self" title="配息時程" data-tab-target="tab-3">配息時程</a>
                    <a href="#" class="c-tab__clone " target="_self" title="相關商品" data-tab-target="tab-4">相關商品</a>
                    <a href="#" class="c-tab__clone " target="_self" title="公司分析" data-tab-target="tab-7">公司分析</a>
                </div>
            </div>
        </div>
        <!-- is-active: 作用中的項目 -->
        <div class="c-tab__panel is-active" data-tab-panel-id="tab-1">
            <section class="l-flex u-flex-col u-flex-gap-sm">
                <div class="l-flex__item">
                </div>
                <div class="l-flex__item"></div>
            </section>
        </div>
        <div class="c-tab__panel" data-tab-panel-id="tab-2">
            <section class="l-flex u-flex-col u-flex-gap-sm">
                <div class="l-flex__item">
                    <section class="c-section u-printBreak">
                        <div class="c-section__content">
                            <div class="c-borderBox">
                                <div class="l-divideList l-divideList--col2@mb-only">
                                    <div class="l-divideList__item">
                                        <div class="c-numerical">
                                            <div class="c-numerical__title c-numerical__title--dk"><span>日期</span></div>
                                            <div class="c-numerical__content c-numerical__content--lg"><span class="t-bold">@Model.BondDetail.Date</span></div>
                                        </div>
                                    </div>
                                    <div class="l-divideList__item">
                                        <div class="c-numerical">
                                            <div class="c-numerical__title c-numerical__title--dk"><span>參考贖回價</span></div>
                                            <div class="c-numerical__content c-numerical__content--lg">
                                                <span class="t-bold">
                                                    @if (Model.BondDetail.RedemptionFee == null)
                                                    {
                                                        <span>-</span>
                                                    }
                                                    else
                                                    {
                                                        <span>@Model.BondDetail.RedemptionFee</span>
                                                    }
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="l-divideList__item">
                                        <div class="c-numerical">
                                            <div class="c-numerical__title c-numerical__title--dk"><span>日漲跌</span></div>
                                            <div class="c-numerical__content c-numerical__content--lg">
                                                <span class="t-bold">
                                                    @if (Model.BondDetail.UpsAndDownsDay == null)
                                                    {
                                                        <div class="c-numerical__content"><span>-</span></div>
                                                    }
                                                    else if (Model.BondDetail.UpsAndDownsDay > 0)
                                                    {
                                                        <div class="c-numerical__content"><span class="o-rise">@Model.BondDetail.UpsAndDownsDay</span></div>
                                                    }
                                                    else if (Model.BondDetail.UpsAndDownsDay < 0)
                                                    {
                                                        <div class="c-numerical__content"><span class="o-fall">@Math.Abs(Model.BondDetail.UpsAndDownsDay.Value)</span></div>
                                                    }
                                                    else
                                                    {
                                                        <div class="c-numerical__content"><span>@Model.BondDetail.UpsAndDownsDay</span></div>
                                                    }
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="l-divideList__item">
                                        <div class="c-numerical">
                                            <div class="c-numerical__title c-numerical__title--dk"><span>日漲跌幅</span></div>
                                            <div class="c-numerical__content c-numerical__content--lg">
                                                <span class="t-bold">
                                                    @if (Model.BondDetail.UpsAndDownsPercentage == null)
                                                    {
                                                        <div class="c-numerical__content"><span>-</span></div>
                                                    }
                                                    else if (Model.BondDetail.UpsAndDownsPercentage > 0)
                                                    {
                                                        <div class="c-numerical__content"><span class="o-rise">@Model.BondDetail.UpsAndDownsPercentage%</span></div>
                                                    }
                                                    else if (Model.BondDetail.UpsAndDownsPercentage < 0)
                                                    {
                                                        <div class="c-numerical__content"><span class="o-fall">@Math.Abs(Model.BondDetail.UpsAndDownsPercentage.Value)%</span></div>
                                                    }
                                                    else
                                                    {
                                                        <div class="c-numerical__content"><span>@Model.BondDetail.UpsAndDownsPercentage%</span></div>
                                                    }
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="l-divideList__item">
                                        <div class="c-numerical">
                                            <div class="c-numerical__title c-numerical__title--dk"><span>計價幣別</span></div>
                                            <div class="c-numerical__content c-numerical__content--lg"><span class="t-bold">@(Model.BondDetail.CurrencyName)</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="c-section u-printBreak">
                        <div class="c-section__title">參考贖回價走勢</div>
                        <div class="c-section__content">
                            <div class="l-flex u-flex-col u-flex-gap-sm">
                                <div class="l-flex__item" data-chart="price">
                                    <div class="c-empty">
                                        <div class="c-empty__img">
                                            <img src="@Url.Content("~/themes/images/lions/lion-keyword.svg")" alt="">
                                        </div>
                                        <div class="c-empty__desc">沒有資料</div>
                                    </div>
                                    <div class="c-chartBox">
                                        <div class="c-chartBox__filter">
                                            <div class="l-flex u-flex-gap-md u-flex-top u-flex-col@lt">
                                                <div class="l-flex__item">
                                                    <div class="l-pickGroup">
                                                        <div class="l-pickGroup__item">
                                                            <label class="o-btnRadio o-btnRadio--capsule o-btnRadio--sm">
                                                                <input class="o-btnRadio__input" type="radio" name="dateRange" value="3m" data-trend-filter="dateRange" checked>
                                                                <div class="o-btnRadio__text"><span>3個月</span></div>
                                                            </label>
                                                        </div>
                                                        <div class="l-pickGroup__item">
                                                            <label class="o-btnRadio o-btnRadio--capsule o-btnRadio--sm">
                                                                <input class="o-btnRadio__input" type="radio" name="dateRange" value="12m" data-trend-filter="dateRange">
                                                                <div class="o-btnRadio__text"><span>1年</span></div>
                                                            </label>
                                                        </div>
                                                        <div class="l-pickGroup__item">
                                                            <label class="o-btnRadio o-btnRadio--capsule o-btnRadio--sm">
                                                                <input class="o-btnRadio__input" type="radio" name="dateRange" value="36m" data-trend-filter="dateRange">
                                                                <div class="o-btnRadio__text"><span>3年</span></div>
                                                            </label>
                                                        </div>
                                                        <div class="l-pickGroup__item">
                                                            <label class="o-btnRadio o-btnRadio--capsule o-btnRadio--sm">
                                                                <input class="o-btnRadio__input" type="radio" name="dateRange" value="60m" data-trend-filter="dateRange">
                                                                <div class="o-btnRadio__text"><span>5年</span></div>
                                                            </label>
                                                        </div>
                                                        <div class="l-pickGroup__item">
                                                            <label class="o-btnRadio o-btnRadio--capsule o-btnRadio--sm">
                                                                <input class="o-btnRadio__input" type="radio" name="dateRange" value="establishment" data-trend-filter="dateRange">
                                                                <div class="o-btnRadio__text"><span>成立至今</span></div>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="c-chartBox__chart">
                                            <div id="priceChart"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="c-section">
                        <div class="c-section__title">近5日參考贖回價</div>
                        <div class="l-table">
                            <table class="c-table u-center u-nowrap" data-fixed-columns data-table-name="">
                                <colgroup>
                                    <col style="width: 1%;">
                                    <col style="width: 1%;">
                                    <col style="width: 1%;">
                                    <col style="width: 1%;">
                                    <col style="width: 1%;">
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th>
                                            <div class="c-table__title">
                                                @if (Model.Top5BondHistoryPrice.Count > 0)
                                                {
                                                    <span>@Model.Top5BondHistoryPrice[0].Date</span>
                                                }
                                                else
                                                {
                                                    <span>-</span>
                                                }
                                            </div>
                                        </th>
                                        <th>
                                            <div class="c-table__title">
                                                @if (Model.Top5BondHistoryPrice.Count > 1)
                                                {
                                                    <span>@Model.Top5BondHistoryPrice[1].Date</span>
                                                }
                                                else
                                                {
                                                    <span>-</span>
                                                }
                                            </div>
                                        </th>
                                        <th>
                                            <div class="c-table__title">
                                                @if (Model.Top5BondHistoryPrice.Count > 2)
                                                {
                                                    <span>@Model.Top5BondHistoryPrice[2].Date</span>
                                                }
                                                else
                                                {
                                                    <span>-</span>
                                                }
                                            </div>
                                        </th>
                                        <th>
                                            <div class="c-table__title">
                                                @if (Model.Top5BondHistoryPrice.Count > 3)
                                                {
                                                    <span>@Model.Top5BondHistoryPrice[3].Date</span>
                                                }
                                                else
                                                {
                                                    <span>-</span>
                                                }
                                            </div>
                                        </th>
                                        <th>
                                            <div class="c-table__title">
                                                @if (Model.Top5BondHistoryPrice.Count > 4)
                                                {
                                                    <span>@Model.Top5BondHistoryPrice[4].Date</span>
                                                }
                                                else
                                                {
                                                    <span>-</span>
                                                }
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            @if (Model.Top5BondHistoryPrice.Count > 0 && Model.Top5BondHistoryPrice[0].RedemptionFee != null)
                                            {
                                                <span>@Model.Top5BondHistoryPrice[0].RedemptionFee</span>
                                            }
                                            else
                                            {
                                                <span>-</span>
                                            }
                                        </td>
                                        <td>
                                            @if (Model.Top5BondHistoryPrice.Count > 1 && Model.Top5BondHistoryPrice[1].RedemptionFee != null)
                                            {
                                                <span>@Model.Top5BondHistoryPrice[1].RedemptionFee</span>
                                            }
                                            else
                                            {
                                                <span>-</span>
                                            }
                                        </td>
                                        <td>
                                            @if (Model.Top5BondHistoryPrice.Count > 2 && Model.Top5BondHistoryPrice[2].RedemptionFee != null)
                                            {
                                                <span>@Model.Top5BondHistoryPrice[2].RedemptionFee</span>
                                            }
                                            else
                                            {
                                                <span>-</span>
                                            }
                                        </td>
                                        <td>
                                            @if (Model.Top5BondHistoryPrice.Count > 3 && Model.Top5BondHistoryPrice[3].RedemptionFee != null)
                                            {
                                                <span>@Model.Top5BondHistoryPrice[3].RedemptionFee</span>
                                            }
                                            else
                                            {
                                                <span>-</span>
                                            }
                                        </td>
                                        <td>
                                            @if (Model.Top5BondHistoryPrice.Count > 4 && Model.Top5BondHistoryPrice[4].RedemptionFee != null)
                                            {
                                                <span>@Model.Top5BondHistoryPrice[4].RedemptionFee</span>
                                            }
                                            else
                                            {
                                                <span>-</span>
                                            }
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                </div>
                <div class="l-flex__item">
                    @Html.Sitecore().Placeholder("BondDetailHistoryPrice")
                </div>
            </section>
        </div>
        <div class="c-tab__panel" data-tab-panel-id="tab-3">
            <section class="l-flex u-flex-col u-flex-gap-sm">
                <div class="l-flex__item">
                </div>
                <div class="l-flex__item"></div>
            </section>
        </div>
        <div class="c-tab__panel" data-tab-panel-id="tab-4">
            <section class="l-flex u-flex-col u-flex-gap-sm">
                <div class="l-flex__item">
                </div>
                <div class="l-flex__item"></div>
            </section>
        </div>
        <div class="c-tab__panel" data-tab-panel-id="tab-7">
            <section class="l-flex u-flex-col u-flex-gap-sm">
                <div class="l-flex__item">
                </div>
                <div class="l-flex__item"></div>
            </section>
        </div>
        <iframe id="SysJustIFRAME" width="100%" scrolling="no" frameborder="0" style="border:none;"></iframe>

        @Html.Sitecore().Placeholder("BondDetail")

        @if (Model.BondDetail.HotProductTags != null && Model.BondDetail.HotProductTags.Any())
        {
            <div class="c-hashTags">
                <div class="c-hashTags__title">Tags</div>
                <div class="c-hashTags__content">
                    <ul class="l-divideList l-divideList--sm">
                        @foreach (var tag in Model.BondDetail.HotProductTags)
                        {
                            <li class="l-divideList__item l-divideList__item--auto">
                                <a href="@(Model.SearchUrl + "?hotproduct=" + tag)" class="o-hashTag u-nowrap">#@tag</a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        }

    </div>
</div>

<script>
    const bondHistoryPrices = @Model.BondHistoryPriceHtmlString;

    $(function () {
        var ACTIONS = {
            APPROVED: 0,
            RESIZE: 1,
            HEIGHT: 2,
            URL: 3,
            UNLOAD: 4,
            NAVIGATE: 5,
            AUTHORIZE: 6,
            SCROLL: 7,
            NAVIGATE_PRODUCT_PATH: 8,
            LOADING_VISIBLE: 9,
            SCROLLAR_VISIBLE: 10,
            WINDOW_SIZE: 11,
        };

        let _targetOrigin = document.location.origin;
        let _selector = '#SysJustIFRAME';
        let _iframeInst = null;
        let _self = this;
        let _name = 'sysjust b2brwd corp';

        function setIframeSrc(val) {
            $(_selector).attr('src', `/b2bbond/BondBasic/Basic0${val}?id=@(Model.BondDetail.ISINCode)&bid=@(Model.BondDetail.BondCode)`);
        }

        function init() {
            setIframeSrc('1');

            // Add Lister to
            $(_selector)
                .on('load', iframeLstr)
                .trigger('load');

            window.addEventListener('message', receiveMessage);
        }

        // iframe Listener
        function iframeLstr(e, url) {
            _iframeInst = document.getElementById($(this).attr('id')).contentWindow;

            _updateWindowSize();

            onResize(function () {
                _postMessage({ action: ACTIONS.RESIZE, data: true });
                _updateWindowSize();
            });
        }

        // resize helper
        function onResize(callback) {
            var reload_timeout;

            $(window).on('resize', function () {
                clearTimeout(reload_timeout);
                reload_timeout = setTimeout(callback, 500);
            });
        }

        function receiveMessage(e) {
            var msg = {};

            try {
                msg = typeof e.data === 'object' ? e.data : JSON.parse(e.data);
            } catch (e) {
                return;
            }

            if (msg.name !== _name) return;

            msg.status = 'receive';
            msg.actionName = _getActionName(msg.action);

            switch (msg.action) {
                case ACTIONS.HEIGHT:
                    $(_selector).outerHeight(msg.data + 10);
                    break;
                default:
                    break;
            }
        }

        function _updateWindowSize() {
            _postMessage({
                action: ACTIONS.WINDOW_SIZE,
                data: {
                    width: window.innerWidth,
                    height: window.innerHeight
                }
            });
        }

        function _postMessage(msg) {
            var luggage = {
                name: _name,
                action: msg.action,
                data: msg.data
            };

            _iframeInst.postMessage(luggage, _targetOrigin);

            luggage.status = 'send';
            luggage.actionName = _getActionName(luggage.action);

        }

        function _getActionName(act) {
            var val;

            Object.entries(ACTIONS).some(function (el) {
                if (el[1] === act) {
                    val = el[0];
                    return true;
                }

                return false;
            });

            return val;
        }

        $('[data-tab-target]').on('click', function () {
            var name = DOMPurify.sanitize($(this).attr("data-tab-target"));
            var val = name.replace('tab-', '');

            if (val == "2") {
                $(_selector).hide();
            }
            else {
                $(_selector).show();
                setIframeSrc(val);
            }
        });

        $('[data-popup]').magnificPopup();
        $('[eh-compare]').trigger('exec');
        $('[eh-focus]').trigger('exec');
        $('[eh-subscription-type]').trigger('exec');

        init();

        $('[data-trend-filter="dateRange"]').on('change', function () {
            getParams();
        });

        var chart;

        function getParams() {
            const obj = {
                range: $('[data-trend-filter="dateRange"]:checked').length > 0 ? $('[data-trend-filter="dateRange"]:checked').val() : "custom",
                startdate: "",
                enddate: "",
            };

            let today = new Date();

            function CalDateRange(month) {
                let set = new Date().setMonth(new Date().getMonth() - month);
                let setDate = new Date(set);
                return setDate.getFullYear() + "-" + ((setDate.getMonth() + 1) < 10 ? "0" + (setDate.getMonth() + 1) : (setDate.getMonth() + 1)) + "-" + setDate.getDate();
            }

            if (!obj.startdate && !obj.enddate) {
                switch (obj.range) {
                    case 'sinceYear':
                        obj.startdate = today.getFullYear() + "-" + "01-01";
                        obj.enddate = today.toISOString().split('T')[0];
                        break;
                    case '3m':
                        obj.startdate = CalDateRange(3)
                        obj.enddate = today.toISOString().split('T')[0];
                        break;
                    case '6m':
                        obj.startdate = CalDateRange(6)
                        obj.enddate = today.toISOString().split('T')[0];
                        break;
                    case '12m':
                        obj.startdate = CalDateRange(12);
                        obj.enddate = today.toISOString().split('T')[0];
                        break;
                    case '24m':
                        obj.startdate = CalDateRange(24);
                        obj.enddate = today.toISOString().split('T')[0];
                        break;
                    case '36m':
                        obj.startdate = CalDateRange(36);
                        obj.enddate = today.toISOString().split('T')[0];
                        break;
                    case '60m':
                        obj.startdate = CalDateRange(60);
                        obj.enddate = today.toISOString().split('T')[0];
                        break;
                    case 'establishment':
                        if (bondHistoryPrices.length > 0) {
                            obj.startdate = bondHistoryPrices[0].Date.replaceAll('/', '-');
                            obj.enddate = today.toISOString().split('T')[0];
                        }
                        break;
                }
            } else {
                obj.startdate = obj.startdate.replaceAll('/', '-');
                obj.enddate = obj.enddate.replaceAll('/', '-');
            }

            if (chart) {
                chart.showLoading();
            }

            initPriceChart(obj);
        }
        function roundToTwo(num) {
            return +(Math.round(num + 'e+2') + 'e-2');
        }
        function CheckSameYear(d1, d2) {
            let d1Year = new Date(d1).getFullYear();
            let d2Year = new Date(d2).getFullYear();
            return d1Year == d2Year
        }
        function CheckSameYearAndMonth(d1, d2) {
            let d1Year = new Date(d1).getFullYear();
            let d2Year = new Date(d2).getFullYear();
            let d1Month = new Date(d1).getMonth() + 1;
            let d2Month = new Date(d2).getMonth() + 1;
            return d1Year == d2Year && d1Month == d2Month
        }
        let preVal;
        function initPriceChart(obj) {
            try {
                let mapData = [];
                var data = bondHistoryPrices.filter(item => item.Date.replaceAll('/', '-') >= obj.startdate && item.Date.replaceAll('/', '-') <= obj.enddate);

                if (data.length != 0) {
                    mapData = data.map(item => {
                        return {
                            x: new Date(item.Date.replaceAll('/', '-')).getTime(),
                            name: item.Date.replaceAll('/', '-'),
                            y: roundToTwo(item.RedemptionFee)
                        };
                    });
                    mapData.reverse();
                }

                let series = {
                    name: "參考贖回價",
                    data: mapData,
                    legendSymbol: 'rectangle',
                    color: obj.netWorth ? '#A4844E' : '#238C6C',
                    turboThreshold: 0,
                };
                chart = Highcharts.stockChart('priceChart', {
                    chart: {
                        zooming: {
                            mouseWheel: {
                                enabled: false
                            }
                        },
                        height: 280
                    },
                    credits: {
                        enabled: false
                    },
                    title: {
                        text: ''
                    },
                    scrollbar: {
                        enabled: false
                    },
                    navigator: {
                        enabled: false
                    },
                    rangeSelector: {
                        enabled: false
                    },
                    legend: {
                        enabled: true,
                        align: 'left',
                        floating: false,
                        y: 20,
                        itemStyle: {
                            fontSize: '1em',
                            color: '#222',
                            cursor: 'default'
                        },
                        itemHoverStyle: {
                            color: '#222'
                        },
                        symbolHeight: 12,
                        symbolWidth: 12
                    },
                    plotOptions: {
                        series: {
                            dataGrouping: {
                                enabled: false
                            },
                            states: {
                                hover: {
                                    enabled: true,
                                    lineWidth: 2,
                                    halo: {
                                        size: 8
                                    }
                                }
                            },
                            events: {
                                legendItemClick: function () {
                                    return false;
                                }
                            }
                        }
                    },
                    tooltip: {
                        split: false,
                        useHTML: true,
                        formatter: function () {
                            const tooltip = '<div style="font-size: 14px">' + '<div style="margin-bottom: 8px; color: #9C9C9C">' + Highcharts.dateFormat('%Y/%m/%d', this.point.x) + '</div>' + '<span style="display:inline-block; color: ' + this.point.color + '; font-size: 18px; margin-right: 3px">\u25CF</span>' + this.point.series.name + ': ' + this.point.y + '</div>';
                            return tooltip;
                        },
                        shadow: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    xAxis: {
                        type: 'datetime',
                        tickPosition: 'inside',
                        tickWidth: 0.5,
                        tickLength: 7,
                        tickInterval: (24 * 3600 * 1000) * 7,
                        labels: {
                            formatter: function () {
                                let format = CheckSameYear(obj.startdate, obj.enddate) ? '%m/%d' : '%Y/%m';
                                let output = null;
                                if (!this.isFirst && format == '%Y/%m') {
                                    if (!CheckSameYearAndMonth(prevVal, this.value)) {
                                        output = Highcharts.dateFormat(format, this.value);
                                    }
                                    prevVal = this.value;
                                } else {
                                    output = Highcharts.dateFormat(format, this.value);
                                    prevVal = this.value;
                                }
                                return output;
                            },
                            style: {
                                color: '#6e6e6e'
                            }
                        },
                        crosshair: {
                            width: 1,
                            color: '#c3c3c3'
                        },
                        lineColor: '#ebebeb',
                        tickColor: '#ebebeb'
                    },
                    yAxis: {
                        showLastLabel: true,
                        opposite: false,
                        labels: {
                            y: 4,
                            formatter: function (value) {
                                return value.value;
                            },
                            style: {
                                color: '#6e6e6e'
                            }
                        },
                        plotLines: [{
                            color: '#c3c3c3'
                        }]
                    },
                    series: [series]
                });

            } catch (error) {
                console.error('Error:', error);
            }
        }

        if (bondHistoryPrices.length > 0) {
            getParams();
            $('[data-chart="price"]').find('.c-empty').addClass('u-hidden');
            $('[data-chart="price"]').find('.c-chartBox, .l-dataNotes').removeClass('u-hidden');
        }
        else {
            $('[data-chart="price"]').find('.c-empty').removeClass('u-hidden');
            $('[data-chart="price"]').find('.c-chartBox, .l-dataNotes').addClass('u-hidden');
        }

    });
</script>